@model PagedResult<UserAccountListViewModel>

@{
    ViewData["Title"] = "User Account Management";

    // Calculate stats from ALL users (not just current page)
    var activeUsers = Model?.Items?.Where(u => u.IsActive) ?? Enumerable.Empty<UserAccountListViewModel>();
    var inactiveUsers = Model?.Items?.Where(u => !u.IsActive) ?? Enumerable.Empty<UserAccountListViewModel>();
    var lockedUsers = Model?.Items?.Where(u => u.LockoutEnd.HasValue && u.LockoutEnd > DateTimeOffset.Now) ?? Enumerable.Empty<UserAccountListViewModel>();
    var totalUsers = Model?.TotalCount ?? 0;
    var activeCount = activeUsers.Count();
    var inactiveCount = inactiveUsers.Count();
    var lockedCount = lockedUsers.Count();
}

<div class="container-fluid px-4">
    <div class="page-header animate-in">
        <div class="container-fluid px-4">
            <div class="d-flex justify-content-between align-items-end flex-wrap gap-3">
            <div>
                <h1>User Account Management</h1>
                <p>Manage system user accounts, permissions, and access controls</p>
            </div>
            <a asp-action="EmployeesWithoutAccounts" class="btn btn-primary btn-primary-lg">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
                <span>Create New Accounts</span>
            </a>
        </div>
    </div>
</div>

    <!-- Stats Cards -->
    <div class="row g-3 mb-4 animate-in">
        <div class="col-lg-3 col-md-6">
            <div class="card">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center gap-3">
                        <div class="d-flex align-items-center justify-content-center" style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--accent-main) 0%, var(--accent-light) 100%); border-radius: var(--radius-md); flex-shrink: 0;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                <circle cx="9" cy="7" r="4" stroke="white" stroke-width="2" />
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </div>
                        <div>
                            <h3 class="mb-0 fw-bold" style="color: var(--accent-main);">@totalUsers</h3>
                            <p class="text-muted mb-0 small">Total Users</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center gap-3">
                        <div class="d-flex align-items-center justify-content-center" style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--success) 0%, #34d399 100%); border-radius: var(--radius-md); flex-shrink: 0;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                <polyline points="22 4 12 14.01 9 11.01" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </div>
                        <div>
                            <h3 class="mb-0 fw-bold" style="color: var(--success);">@activeCount</h3>
                            <p class="text-muted mb-0 small">Active</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center gap-3">
                        <div class="d-flex align-items-center justify-content-center" style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--gray-400) 0%, var(--gray-500) 100%); border-radius: var(--radius-md); flex-shrink: 0;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" />
                                <line x1="15" y1="9" x2="9" y2="15" stroke="white" stroke-width="2" stroke-linecap="round" />
                                <line x1="9" y1="9" x2="15" y2="15" stroke="white" stroke-width="2" stroke-linecap="round" />
                            </svg>
                        </div>
                        <div>
                            <h3 class="mb-0 fw-bold" style="color: var(--gray-500);">@inactiveCount</h3>
                            <p class="text-muted mb-0 small">Inactive</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center gap-3">
                        <div class="d-flex align-items-center justify-content-center" style="width: 48px; height: 48px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: var(--radius-md); flex-shrink: 0;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="5" y="5" width="14" height="14" rx="2" stroke="white" stroke-width="2" stroke-linecap="round" />
                                <path d="M9 10l6 6M15 10l-6 6" stroke="white" stroke-width="2" stroke-linecap="round" />
                            </svg>
                        </div>
                        <div>
                            <h3 class="mb-0 fw-bold" style="color: #dc2626;">@lockedCount</h3>
                            <p class="text-muted mb-0 small">Locked Out</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-3 animate-in">
        <div class="card-body p-3">
            <div class="row g-3 align-items-center">
                <div class="col-lg-6">
                    <div class="input-group">
                        <span class="input-group-text" style="background-color: var(--gray-50); border: 1.5px solid var(--gray-300);">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </span>
                        <input type="text" id="searchInput" class="form-control" placeholder="Search users by email, name, or role...">
                        <button class="btn btn-outline-secondary" type="button" title="Clear search">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="d-flex gap-2 flex-wrap justify-content-lg-end">
                        <a asp-action="EmployeesWithoutAccounts" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-user-plus me-1"></i>View Employees Without Accounts
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (Model != null && Model.Items != null && Model.Items.Any())
    {
        <div class="table-container animate-in">
            <table class="table table-hover mb-0" id="userTable">
                <thead>
                    <tr>
                        <th style="width: 40px;">#</th>
                        <th>User Account</th>
                        <th>Employee Details</th>
                        <th>Roles</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th class="text-center" style="width: 150px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int index = (Model.PageNumber - 1) * Model.PageSize + 1;
                    }
                    @foreach (var user in Model.Items)
                    {
                        <tr>
                            <td>
                                <span class="table-code">@(index++)</span>
                            </td>
                            <td>
                                <div>
                                    <strong>@user.Email</strong>
                                    <br>
                                    @if (user.RequirePasswordChange)
                                    {
                                        <span class="badge" style="background-color: #fef3c7; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">
                                            <i class="fas fa-key me-1"></i>Password Change Required
                                        </span>
                                    }
                                </div>
                            </td>
                            <td>
                                @if (user.EmployeeId.HasValue)
                                {
                                    <div>
                                        <a asp-controller="Employee" asp-action="Profile" asp-route-id="@user.EmployeeId" class="clickable-link">
                                            <strong>@user.EmployeeName</strong>
                                        </a>
                                        <br>
                                        <small class="text-muted">ID: @user.EmployeeId</small>
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted small">No Employee Linked</span>
                                }
                            </td>
                            <td>
                                <div class="d-flex flex-wrap gap-1">
                                    @foreach (var role in user.Roles)
                                    {
                                        <span class="badge @GetRoleBadgeClass(role)">@role</span>
                                    }
                                </div>
                            </td>
                            <td>
                                @if (user.LockoutEnd.HasValue && user.LockoutEnd > DateTimeOffset.Now)
                                {
                                    <span class="badge" style="background-color: #fee2e2; color: #991b1b; padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-weight: 500; font-size: 0.8125rem;">
                                        <i class="fas fa-lock me-1"></i>Locked Out
                                    </span>
                                }
                                else if (user.IsActive)
                                {
                                    <span class="badge" style="background-color: #dcfce7; color: #166534; padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-weight: 500; font-size: 0.8125rem;">
                                        <i class="fas fa-check-circle me-1"></i>Active
                                    </span>
                                }
                                else
                                {
                                    <span class="badge" style="background-color: #f3f4f6; color: #4b5563; padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-weight: 500; font-size: 0.8125rem;">
                                        <i class="fas fa-ban me-1"></i>Inactive
                                    </span>
                                }
                                @if (user.AccessFailedCount > 0)
                                {
                                    <br>
                                    <small class="text-muted">Failed attempts: @user.AccessFailedCount</small>
                                }
                            </td>
                            <td>
                                <span class="text-muted">@user.CreatedAt.ToString("MMM dd, yyyy")</span>
                            </td>
                            <td class="text-center">
                                <div class="d-inline-flex gap-1">
                                    <form asp-action="ToggleAccountStatus" asp-route-userId="@user.UserId" method="post" style="display:inline;">
                                        @Html.AntiForgeryToken()
                                        <button type="submit"
                                                class="btn btn-sm @(user.IsActive ? "btn-outline-warning" : "btn-outline-success")"
                                                onclick="return confirm('Are you sure you want to @(user.IsActive ? "deactivate" : "activate") this account?')">
                                            <i class="fas @(user.IsActive ? "fa-ban" : "fa-check")"></i>
                                            @(user.IsActive ? "Deactivate" : "Activate")
                                        </button>
                                    </form>
                                    @if (User.IsInRole("CEO") || User.IsInRole("ITAdmin"))
                                    {
                                        <a asp-controller="Account" asp-action="ResetPasswordByAdmin" class="btn btn-sm btn-outline-secondary" title="Reset Password">
                                            <i class="fas fa-key"></i>
                                        </a>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        @if (Model.TotalPages > 1)
        {
            var paginationInfo = new PaginationInfoViewModel
            {
                PageNumber = Model.PageNumber,
                PageSize = Model.PageSize,
                TotalCount = Model.TotalCount
            };

            <partial name="_PaginationPartial" model="@paginationInfo"
                     view-data="@(new ViewDataDictionary(ViewData) { { "ItemName", "user accounts" } })" />
        }
    }
    else
    {
        <div class="card animate-in">
            <div class="empty-state">
                <div class="empty-state-icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" />
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>
                <h5>No User Accounts Found</h5>
                <p>Start by creating user accounts for employees without system access.</p>
                <a asp-action="EmployeesWithoutAccounts" class="btn btn-primary btn-primary-lg">
                    <i class="fas fa-user-plus me-2"></i>
                    Create User Accounts
                </a>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Simple client-side search functionality
            const searchInput = document.getElementById('searchInput');
            const userTable = document.getElementById('userTable');

            if (searchInput && userTable) {
                searchInput.addEventListener('keyup', function() {
                    const searchTerm = this.value.toLowerCase();
                    const rows = userTable.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

                    for (let row of rows) {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    }
                });
            }
        });
    </script>
}

@functions {
    string GetRoleBadgeClass(string role)
    {
        return role switch
        {
            "CEO" => "badge-custom-ceo",
            "ITAdmin" => "badge-custom-itadmin",
            "DepartmentManager" => "badge-custom-manager",
            "ProjectManager" => "badge-custom-pm",
            "Employee" => "badge-custom-employee",
            _ => "badge-custom"
        };
    }
}