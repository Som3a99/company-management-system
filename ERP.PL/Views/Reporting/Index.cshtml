@model ReportingIndexViewModel
@{
    ViewData["Title"] = "Operational Reports";
}

<div class="container-fluid px-4 py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Operational Reports</h2>
        <a class="btn btn-outline-dark" asp-action="Jobs">Async Jobs & Presets</a>
    </div>

    @if (!string.IsNullOrWhiteSpace(ViewData["CacheStatus"]?.ToString()))
    {
        <div class="alert alert-info py-2 d-flex justify-content-between align-items-center" role="alert">
            <span>Results cache: <strong>@ViewData["CacheStatus"]</strong></span>
            <small class="text-muted">Updated @(((DateTime?)ViewData["CacheGeneratedUtc"])?.ToString("u"))</small>
        </div>
    }

    <form method="get" class="card card-body mb-4">
        <div class="row g-3">
            <div class="col-md-2">
                <label class="form-label">Start Date (UTC)</label>
                <input asp-for="Filters.StartDateUtc" type="date" class="form-control" />
            </div>
            <div class="col-md-2">
                <label class="form-label">End Date (UTC)</label>
                <input asp-for="Filters.EndDateUtc" type="date" class="form-control" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Department Id</label>
                <input asp-for="Filters.DepartmentId" class="form-control" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Project Id</label>
                <input asp-for="Filters.ProjectId" class="form-control" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Export Format</label>
                <select asp-for="Filters.Export" class="form-select" asp-items="Html.GetEnumSelectList<ERP.PL.ViewModels.Reporting.ReportExportFormat>()"></select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-primary w-100" type="submit">Apply Filters</button>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <a class="btn btn-outline-danger w-100" asp-action="Index"
                   asp-route-StartDateUtc="@Model.Filters.StartDateUtc?.ToString("yyyy-MM-dd")"
                   asp-route-EndDateUtc="@Model.Filters.EndDateUtc?.ToString("yyyy-MM-dd")"
                   asp-route-DepartmentId="@Model.Filters.DepartmentId"
                   asp-route-ProjectId="@Model.Filters.ProjectId"
                   asp-route-Export="@Model.Filters.Export"
                   asp-route-refreshCache="true">Refresh (Bypass Cache)</a>
            </div>
        </div>
    </form>

    @if (!string.IsNullOrWhiteSpace(ViewBag.AISummary as string))
    {
        <div class="card mb-4 border-start border-4 border-primary">
            <div class="card-body">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                    </svg>
                    <strong>AI Executive Summary</strong>
                </div>
                <p class="mb-0">@ViewBag.AISummary</p>
            </div>
        </div>
    }

    <div class="row g-3 mb-4">
        <div class="col-md-3"><div class="card"><div class="card-body"><small class="text-muted">Total Tasks</small><h4>@Model.Widget.TotalTasks</h4></div></div></div>
        <div class="col-md-3"><div class="card"><div class="card-body"><small class="text-muted">Overdue Tasks</small><h4 class="text-danger">@Model.Widget.OverdueTasks</h4></div></div></div>
        <div class="col-md-3"><div class="card"><div class="card-body"><small class="text-muted">Total Projects</small><h4>@Model.Widget.TotalProjects</h4></div></div></div>
        <div class="col-md-3"><div class="card"><div class="card-body"><small class="text-muted">Active Projects</small><h4 class="text-success">@Model.Widget.ActiveProjects</h4></div></div></div>
    </div>

    <div class="d-flex gap-2 mb-2">
        <a class="btn btn-outline-secondary btn-sm" asp-action="ExportTasks" asp-route-StartDateUtc="@Model.Filters.StartDateUtc?.ToString("yyyy-MM-dd")" asp-route-EndDateUtc="@Model.Filters.EndDateUtc?.ToString("yyyy-MM-dd")" asp-route-DepartmentId="@Model.Filters.DepartmentId" asp-route-ProjectId="@Model.Filters.ProjectId" asp-route-Export="@Model.Filters.Export">Export Tasks</a>
        <a class="btn btn-outline-secondary btn-sm" asp-action="ExportProjects" asp-route-StartDateUtc="@Model.Filters.StartDateUtc?.ToString("yyyy-MM-dd")" asp-route-EndDateUtc="@Model.Filters.EndDateUtc?.ToString("yyyy-MM-dd")" asp-route-DepartmentId="@Model.Filters.DepartmentId" asp-route-ProjectId="@Model.Filters.ProjectId" asp-route-Export="@Model.Filters.Export">Export Projects</a>
        <a class="btn btn-outline-secondary btn-sm" asp-action="Department">Department Reports</a>
        <a class="btn btn-outline-secondary btn-sm" asp-action="EstimationAccuracy">Estimation Accuracy</a>
        @if (User.IsInRole("CEO"))
        {
            <a class="btn btn-outline-secondary btn-sm" asp-action="Audit">Audit Reports</a>
        }
    </div>

    <div class="card mb-4">
        <div class="card-header fw-bold">Task Report</div>
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm mb-0">
                <thead class="table-light"><tr><th>Id</th><th>Title</th><th>Status</th><th>Priority</th><th>Project</th><th>Assignee</th><th>Due (UTC)</th><th>Hours (Est/Actual)</th></tr></thead>
                <tbody>
                    @foreach (var row in Model.TaskRows)
                    {
                        <tr>
                            <td>@row.TaskId</td>
                            <td>@row.Title</td>
                            <td>@row.Status</td>
                            <td>@row.Priority</td>
                            <td>@row.Project</td>
                            <td>@row.Assignee</td>
                            <td>@row.DueDateUtc?.ToString("u")</td>
                            <td>@row.EstimatedHours / @row.ActualHours</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <div class="card-header fw-bold">Project Report</div>
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm mb-0">
                <thead class="table-light"><tr><th>Id</th><th>Code</th><th>Name</th><th>Department</th><th>Status</th><th>Budget</th><th>Task Completion</th></tr></thead>
                <tbody>
                    @foreach (var row in Model.ProjectRows)
                    {
                        var percent = row.TotalTasks == 0 ? 0 : (int)Math.Round((double)row.CompletedTasks * 100 / row.TotalTasks);
                        <tr>
                            <td>@row.ProjectId</td>
                            <td>@row.ProjectCode</td>
                            <td>@row.ProjectName</td>
                            <td>@row.DepartmentName</td>
                            <td>@row.Status</td>
                            <td>@row.Budget</td>
                            <td>@row.CompletedTasks/@row.TotalTasks (@percent%)</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>