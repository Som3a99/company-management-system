@model List<ERP.DAL.Models.AppNotification>
@using ERP.DAL.Models
@{
    ViewData["Title"] = "Notifications";
    var currentSeverity = ViewBag.CurrentSeverity as NotificationSeverity?;
    var currentType = ViewBag.CurrentType as NotificationType?;
    var currentPage = (int)(ViewBag.CurrentPage ?? 1);
    var hasMore = (bool)(ViewBag.HasMore ?? false);
}

<div class="container-fluid px-4 py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-1"><i class="fas fa-bell me-2"></i>Notifications</h4>
            <small class="text-muted">Your recent notifications and alerts</small>
        </div>
        <div>
            <button type="button" class="btn btn-outline-primary btn-sm" id="markAllReadPageBtn">
                <i class="fas fa-check-double me-1"></i>Mark All Read
            </button>
        </div>
    </div>

    @* ── Filters ────────────────────────────────── *@
    <div class="card mb-4">
        <div class="card-body py-2">
            <form method="get" class="d-flex gap-3 align-items-center flex-wrap">
                <div>
                    <label class="form-label small mb-0 me-1">Severity:</label>
                    <select name="severity" class="form-select form-select-sm d-inline-block" style="width:auto;" onchange="this.form.submit()">
                        <option value="">All</option>
                        <option value="@((int)NotificationSeverity.Info)" selected="@(currentSeverity == NotificationSeverity.Info)">Info</option>
                        <option value="@((int)NotificationSeverity.Warning)" selected="@(currentSeverity == NotificationSeverity.Warning)">Warning</option>
                        <option value="@((int)NotificationSeverity.Critical)" selected="@(currentSeverity == NotificationSeverity.Critical)">Critical</option>
                    </select>
                </div>
                <div>
                    <label class="form-label small mb-0 me-1">Type:</label>
                    <select name="type" class="form-select form-select-sm d-inline-block" style="width:auto;" onchange="this.form.submit()">
                        <option value="">All</option>
                        @foreach (var t in Enum.GetValues<NotificationType>())
                        {
                            <option value="@((int)t)" selected="@(currentType == t)">@t</option>
                        }
                    </select>
                </div>
                @if (currentSeverity.HasValue || currentType.HasValue)
                {
                    <a href="/Notifications" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-times me-1"></i>Clear Filters
                    </a>
                }
            </form>
        </div>
    </div>

    @* ── Notification List ──────────────────────── *@
    @if (Model.Count == 0)
    {
        <div class="text-center text-muted py-5">
            <i class="fas fa-bell-slash fs-1 mb-3 d-block"></i>
            <p>No notifications to display.</p>
        </div>
    }
    else
    {
        <div class="list-group">
            @foreach (var n in Model)
            {
                var (iconClass, colorClass, bgClass) = n.Severity switch
                {
                    NotificationSeverity.Critical => ("fa-exclamation-triangle", "text-danger", "border-start border-danger border-3"),
                    NotificationSeverity.Warning => ("fa-clock", "text-warning", "border-start border-warning border-3"),
                    _ => ("fa-bell", "text-primary", "border-start border-primary border-3")
                };
                var readClass = n.IsRead ? "opacity-75" : "";

                <a href="@(n.LinkUrl ?? "#")"
                   class="list-group-item list-group-item-action d-flex align-items-start py-3 @bgClass @readClass"
                   data-notif-id="@n.Id"
                   onclick="markNotifReadPage(@n.Id)">
                    <i class="fas @iconClass @colorClass me-3 mt-1 fs-5"></i>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="mb-1 @(n.IsRead ? "" : "fw-bold")">@n.Title</h6>
                            <small class="text-muted ms-2 text-nowrap">
                                @{
                                    var span = DateTime.UtcNow - n.CreatedAt;
                                    string timeAgo;
                                    if (span.TotalMinutes < 1) timeAgo = "just now";
                                    else if (span.TotalMinutes < 60) timeAgo = $"{(int)span.TotalMinutes}m ago";
                                    else if (span.TotalHours < 24) timeAgo = $"{(int)span.TotalHours}h ago";
                                    else if (span.TotalDays < 7) timeAgo = $"{(int)span.TotalDays}d ago";
                                    else timeAgo = n.CreatedAt.ToString("MMM dd, yyyy");
                                }
                                @timeAgo
                            </small>
                        </div>
                        <p class="mb-1 small">@n.Message</p>
                        <div class="d-flex gap-2">
                            <span class="badge bg-light text-dark">@n.Type</span>
                            @if (!n.IsRead)
                            {
                                <span class="badge bg-primary">New</span>
                            }
                            @if (n.IsSystemGenerated)
                            {
                                <span class="badge bg-secondary">System</span>
                            }
                        </div>
                    </div>
                </a>
            }
        </div>

        @* ── Pagination ──────────────────────── *@
        <nav class="mt-3">
            <ul class="pagination justify-content-center">
                @if (currentPage > 1)
                {
                    <li class="page-item">
                        <a class="page-link" href="/Notifications?page=@(currentPage - 1)&severity=@currentSeverity&type=@currentType">
                            <i class="fas fa-chevron-left"></i> Previous
                        </a>
                    </li>
                }
                @if (hasMore)
                {
                    <li class="page-item">
                        <a class="page-link" href="/Notifications?page=@(currentPage + 1)&severity=@currentSeverity&type=@currentType">
                            Next <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                }
            </ul>
        </nav>
    }
</div>

@section Scripts {
    <script>
        function markNotifReadPage(id) {
            fetch('/Notifications/MarkRead?id=' + id, { method: 'POST' }).catch(() => { });
        }

        document.getElementById('markAllReadPageBtn')?.addEventListener('click', function () {
            fetch('/Notifications/MarkAllRead', { method: 'POST' })
                .then(() => location.reload())
                .catch(() => { });
        });
    </script>
}
